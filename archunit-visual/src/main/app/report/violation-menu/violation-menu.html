<template id="violation-menu-template">
  <link rel="stylesheet" href="violation-menu.css">
  <div id="bar-root">
    <div id="showbar" class="show-bar"><</div>
    <div id="verticalDivider">
      <div class="title">Violation-rules:</div>
      <div class="violation-rule-list"></div>
      <div id="hideAllDepsWhenRuleSelectedSetting">
        <input type="checkbox" class="checkbox" id="hideAllDepsWhenRuleSelected" checked>
        <label for="hideAllDepsWhenRuleSelected">hide all other dependencies when rule selected</label>
      </div>
    </div>
  </div>
</template>

<script>
  (function () {
    const webComponents = require('web-component-infrastructure');
    const d3 = require('visualization').d3;
    let violationRules;
    let getViolationGroupOfRule;

    webComponents.defineCustomElement('violation-menu', class extends HTMLElement {
      postConnected() {
        const showBar = d3.select(this.shadowRoot.querySelector('#showbar'));
        const verticalDivider = d3.select(this.shadowRoot.querySelector('#verticalDivider'));
        let violationMenuIsVisible = verticalDivider.style('display') === 'flex';
        showBar.on('click', () => {
          violationMenuIsVisible = !violationMenuIsVisible;
          verticalDivider.style('display', violationMenuIsVisible ? 'flex' : 'none');
          showBar.text(violationMenuIsVisible ? '>' : '<');
        });
      }

      setViolations(violations) {
        getViolationGroupOfRule = rule => violations.filter(violationGroup => violationGroup.rule === rule)[0];

        const violationRuleList = d3.select(this.shadowRoot.querySelector('.violation-rule-list'));
        const rules = violations.map(violationGroup => violationGroup.rule);
        violationRules = violationRuleList.selectAll('span').data(rules).enter().append('span').text(rule => rule);
      }

      initialize(showViolationsOfRule, hideViolationsOfRule, onHideAllDependenciesChanged) {
        const markedRules = new Set();
        violationRules.on('click', function (rule) {
          if (markedRules.has(rule)) {
            markedRules.delete(rule);
            d3.select(this).attr('class', '');
            hideViolationsOfRule(getViolationGroupOfRule(rule));
          }
          else {
            markedRules.add(rule);
            d3.select(this).attr('class', 'marked');
            showViolationsOfRule(getViolationGroupOfRule(rule));
          }
        });

        this._onHideAllDependenciesChanged(onHideAllDependenciesChanged);
      }

      _onHideAllDependenciesChanged(callback) {
        const checkbox = this.shadowRoot.querySelector('#hideAllDepsWhenRuleSelected');
        checkbox.onclick = () => callback(checkbox.checked);
        callback(checkbox.checked); //sync initial state
      }
    });
  }());
</script>